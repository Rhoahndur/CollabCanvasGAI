rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns a document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Canvas collections
    match /canvases/{canvasId} {
      // For MVP, we'll use a single default canvas
      // In future, can expand to multiple canvases with ownership
      
      // Canvas objects (rectangles, shapes)
      match /objects/{objectId} {
        // Anyone authenticated can read objects
        allow read: if isAuthenticated();
        
        // Users can create objects with their own userId in the composite ID
        allow create: if isAuthenticated() 
                      && request.resource.data.createdBy == request.auth.uid;
        
        // Users can update objects they created or that are unlocked
        allow update: if isAuthenticated() 
                      && (resource.data.createdBy == request.auth.uid
                          || resource.data.lockedBy == null
                          || resource.data.lockedBy == request.auth.uid);
        
        // Users can delete objects they created
        allow delete: if isAuthenticated() 
                      && resource.data.createdBy == request.auth.uid;
      }
      
      // Cursor positions (session-based)
      match /cursors/{sessionId} {
        // Anyone authenticated can read all cursors
        allow read: if isAuthenticated();
        
        // Users can write/delete their own cursor sessions
        // Check that the userId field in the document matches the authenticated user
        allow create: if isAuthenticated() 
                      && request.resource.data.userId == request.auth.uid;
        
        allow update, delete: if isAuthenticated() 
                               && (resource.data.userId == request.auth.uid
                                   || request.resource.data.userId == request.auth.uid);
      }
      
      // Presence/online status
      match /presence/{userId} {
        // Anyone authenticated can read presence
        allow read: if isAuthenticated();
        
        // Users can only write their own presence
        allow write: if isOwner(userId);
      }
    }
  }
}

