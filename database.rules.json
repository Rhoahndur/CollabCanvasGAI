{
  "rules": {
    "canvases": {
      "$canvasId": {
        "metadata": {
          ".read": "auth != null && (root.child('canvases').child($canvasId).child('permissions').child(auth.uid).exists() || root.child('userCanvases').child(auth.uid).child($canvasId).exists())",
          ".write": "auth != null && (root.child('canvases').child($canvasId).child('permissions').child(auth.uid).val() == 'owner' || root.child('canvases').child($canvasId).child('permissions').child(auth.uid).val() == 'editor' || !root.child('canvases').child($canvasId).child('metadata').exists())"
        },
        "permissions": {
          ".read": "auth != null && (root.child('canvases').child($canvasId).child('permissions').child(auth.uid).exists() || root.child('userCanvases').child(auth.uid).child($canvasId).exists())",
          "$userId": {
            ".write": "auth != null && (root.child('canvases').child($canvasId).child('permissions').child(auth.uid).val() == 'owner' || (auth.uid == $userId && !root.child('canvases').child($canvasId).child('permissions').exists()))"
          }
        },
        "objects": {
          ".read": "auth != null && (root.child('canvases').child($canvasId).child('permissions').child(auth.uid).exists() || root.child('userCanvases').child(auth.uid).child($canvasId).exists())",
          "$objectId": {
            ".write": "auth != null && (root.child('canvases').child($canvasId).child('permissions').child(auth.uid).val() == 'owner' || root.child('canvases').child($canvasId).child('permissions').child(auth.uid).val() == 'editor' || (root.child('userCanvases').child(auth.uid).child($canvasId).exists() && (root.child('userCanvases').child(auth.uid).child($canvasId).child('role').val() == 'owner' || root.child('userCanvases').child(auth.uid).child($canvasId).child('role').val() == 'editor')))"
          }
        },
        "cursors": {
          ".read": "auth != null && (root.child('canvases').child($canvasId).child('permissions').child(auth.uid).exists() || root.child('userCanvases').child(auth.uid).child($canvasId).exists())",
          "$sessionId": {
            ".write": "auth != null"
          }
        },
        "presence": {
          ".read": "auth != null && (root.child('canvases').child($canvasId).child('permissions').child(auth.uid).exists() || root.child('userCanvases').child(auth.uid).child($canvasId).exists())",
          "$sessionId": {
            ".write": "auth != null"
          }
        }
      }
    },
    "userCanvases": {
      "$userId": {
        ".read": "auth != null && auth.uid == $userId",
        ".write": "auth != null && auth.uid == $userId"
      }
    }
  }
}
